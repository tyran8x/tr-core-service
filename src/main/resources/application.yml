# ===================================================================
# TR-CORE-SERVICE: CẤU HÌNH CƠ SỞ (BASE CONFIGURATION)
# Phù hợp cho môi trường Production.
# Các giá trị nhạy cảm và thay đổi theo môi trường được cung cấp qua
# biến môi trường (ví dụ: Docker, Kubernetes) hoặc file .env (cho local).
# ===================================================================

# ===================================================================
# 1. SERVER CONFIGURATION
# ===================================================================
server:
  port: 8989
  servlet:
    context-path: /
  # Sử dụng Undertow cho hiệu suất cao trong môi trường non-blocking
  undertow:
    threads:
      io: ${UNDERTOW_IO_THREADS:16}        # Số luồng I/O nên tương đương số lõi CPU
      worker: ${UNDERTOW_WORKER_THREADS:256}  # Số luồng xử lý tác vụ
    direct-buffers: true
    max-http-post-size: 100MB # Cho phép upload file lớn
  # Tắt server một cách mượt mà, xử lý nốt các request đang chạy
  shutdown: graceful
  # Bật nén GZIP/Brotli để giảm băng thông
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css,image/svg+xml
    min-response-size: 2048 # Chỉ nén response > 2KBadmin-server

# ===================================================================
# 2. SPRING FRAMEWORK
# ===================================================================
spring:
  application:
    name: tr-core-service
  # Kích hoạt profile theo biến môi trường. Mặc định là 'prod' để an toàn.
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:prod}
  # Cấu hình để Spring Boot đọc file .env (hữu ích cho môi trường local)
  config:
    import:
      - "optional:configserver:http://10.49.41.112:8888"
  messages:
    basename: i18n/messages
  servlet:
    multipart:
      max-file-size: 100MB
      max-request-size: 100MB

  # --- Datasource (PostgreSQL with HikariCP) ---
  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://10.49.41.112:5432/core_service}
    username: ${SPRING_DATASOURCE_USERNAME} # BẮT BUỘC cung cấp qua env
    password: ${SPRING_DATASOURCE_PASSWORD} # BẮT BUỘC cung cấp qua env
    driver-class-name: org.postgresql.Driver
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      pool-name: HikariPool-CoreService
      maximum-pool-size: ${HIKARI_MAX_POOL_SIZE:20}
      minimum-idle: ${HIKARI_MIN_IDLE:5}
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  # --- Redis (Lettuce Pool) ---
  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST:10.49.41.112}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      password: ${SPRING_DATA_REDIS_PASSWORD} # BẮT BUỘC cung cấp qua env
      timeout: 10s
      ssl:
        enabled: ${SPRING_DATA_REDIS_SSL_ENABLED:false}
      lettuce:
        pool:
          max-active: ${REDIS_POOL_MAX_ACTIVE:32}
          max-idle: ${REDIS_POOL_MAX_IDLE:16}
          min-idle: ${REDIS_POOL_MIN_IDLE:4}

  # --- Kafka ---
  kafka:
    bootstrap-servers: ${SPRING_KAFKA_BOOTSTRAP_SERVERS:10.49.41.112:9092}
    properties:
      security.protocol: ${KAFKA_SECURITY_PROTOCOL:PLAINTEXT}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
    consumer:
      group-id: ${spring.application.name} # Sử dụng tên ứng dụng làm group-id
      auto-offset-reset: latest
      key-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      properties:
        spring.json.trusted.packages: '*'
        spring.deserializer.key.delegate.class: org.apache.kafka.common.serialization.StringDeserializer
        spring.deserializer.value.delegate.class: org.springframework.kafka.support.serializer.JsonDeserializer
    listener:
      missing-topics-fatal: false

  # --- Spring Security ---
  # Dùng để bảo vệ các endpoint quản trị (Actuator, DevOps Dashboard)
  security:
    user:
      name: ${SECURITY_USER_NAME}       # BẮT BUỘC cung cấp qua env
      password: ${SECURITY_USER_PASSWORD} # BẮT BUỘC cung cấp qua env
      roles: ADMIN

  boot:
    admin:
      client:
        url: ${SPRING_BOOT_ADMIN_CLIENT_URL:http://10.49.41.112:9090}

# ===================================================================
# 3. SA-TOKEN: AUTHENTICATION & AUTHORIZATION
# ===================================================================
sa-token:
  token-name: X-Token
  timeout: 604800
  active-timeout: 259200
  is-concurrent: true
  is-share: true
  token-style: jwt
  jwt-secret-key: ${JWT_SECRET_KEY} # BẮT BUỘC cung cấp qua env, không có giá trị mặc định
  is-log: false

# ===================================================================
# 4. MANAGEMENT & OBSERVABILITY
# ===================================================================
management:
  endpoints:
    web:
      exposure:
        include: health, info, prometheus, metrics, logfile
  endpoint:
    health:
      show-details: when_authorized
      probes:
        enabled: true

logging:
  config: classpath:logback.xml
  file:
    path: ${LOGGING_FILE_PATH:/opt/logs}
  level:
    root: INFO
    vn.tr: INFO
    org.springframework: WARN
    org.hibernate: WARN
    cn.dev33.satoken: WARN

# ===================================================================
# 5. MICROSERVICE INFRASTRUCTURE
# ===================================================================
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://eureka-server:8761/eureka/}
  instance:
    prefer-ip-address: true

# ===================================================================
# 6. APPLICATION SPECIFIC CONFIGURATION
# ===================================================================
app:
  name: Tr-Pro-App
  version: '@project.version@' # Lấy phiên bản từ Maven/Gradle
  copyrightYear: 2025

core:
  attachment:
    host:
      download: ${CORE_ATTACHMENT_HOST_DOWNLOAD:https://api.dnict.vn/v2/core}
    path:
      upload: ${CORE_ATTACHMENT_PATH_UPLOAD:/opt/uploads}
      uploadtemp: ${CORE_ATTACHMENT_PATH_UPLOADTEMP:/opt/uploads/temp}

user:
  password:
    maxRetryCount: ${USER_PASSWORD_MAX_RETRY:5}
    lockTime: ${USER_PASSWORD_LOCK_TIME:10} # Đơn vị: phút

captcha:
  enable: ${CAPTCHA_ENABLED:true}
  type: CHAR
  category: CIRCLE
  numberLength: 1
  charLength: 4

redisson:
  keyPrefix: ${REDISSON_KEY_PREFIX:${spring.application.name}} # Tiền tố key Redisson
  threads: ${REDISSON_THREADS:4}
  nettyThreads: ${REDISSON_NETTY_THREADS:8}
  singleServerConfig:
    clientName: ${spring.application.name}
    connectionMinimumIdleSize: ${REDISSON_POOL_MIN_IDLE:8}
    connectionPoolSize: ${REDISSON_POOL_MAX_SIZE:32}
    idleConnectionTimeout: ${REDISSON_IDLE_TIMEOUT:10000}
    timeout: ${REDISSON_CMD_TIMEOUT:3000}
    subscriptionConnectionPoolSize: ${REDISSON_SUB_POOL_SIZE:50}

websocket:
  enabled: ${WEBSOCKET_ENABLED:true}
  path: /resource/websocket
  # BẮT BUỘC: Cấu hình chính xác tên miền frontend của bạn để tránh tấn công CSRF/CORS
  allowedOrigins: ${WEBSOCKET_ALLOWED_ORIGINS}

security:
  # Các đường dẫn này sẽ được bỏ qua bởi Sa-Token Interceptor.
  # Lưu ý: /actuator/** và /sa-token/devops đã được gỡ bỏ khỏi đây
  # vì chúng sẽ được bảo vệ bởi Spring Security.
  excludes:
    - /css/**
    - /js/**
    - /img/**
    - /assets/**
    - /favicon.ico
    - /error
    - /doc.html
    - /swagger-ui.html
    - /swagger-ui/**
    - /webjars/**
    - /v3/api-docs/**
    - /auth/login
    - /auth/logout
    - /auth/register
    - /auth/captcha/code
    - /mobile/**
    - /attachment/download/**
    - /webhook/**
    - /p/**
    - /eureka/**

api-decrypt:
  enabled: ${API_DECRYPT_ENABLED:false}
  headerFlag: encrypt-key
  # BÍ MẬT: Các key này phải được cung cấp qua biến môi trường.
  publicKey: ${API_DECRYPT_PUBLIC_KEY}
  privateKey: ${API_DECRYPT_PRIVATE_KEY}

client:
  notification-service:
    url: ${CLIENT_NOTIFICATION_SERVICE_URL:http://notification-service:8000/v1/notification}
