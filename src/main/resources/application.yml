# ===================================================================
# TR-CORE-SERVICE: CẤU HÌNH CƠ SỞ (BASE CONFIGURATION)
# ===================================================================

# -------------------------------------------------------------------
# 1. SERVER CONFIGURATION
# -------------------------------------------------------------------
server:
  port: 8989
  shutdown: graceful
  servlet:
    context-path: /
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css,image/svg+xml
    min-response-size: 2048

# -------------------------------------------------------------------
# 2. SPRING FRAMEWORK
# -------------------------------------------------------------------
spring:
  application:
    name: tr-core-service
  config:
    import: "optional:configserver:${SPRING_CLOUD_CONFIG_URI:http://localhost:8888}"
  jackson:
    serialization:
      FAIL_ON_EMPTY_BEANS: false
    deserialization:
      FAIL_ON_UNKNOWN_PROPERTIES: false
    default-property-inclusion: non_null
    time-zone: Asia/Ho_Chi_Minh
  messages:
    basename: i18n/messages
  servlet:
    multipart:
      max-file-size: 100MB
      max-request-size: 100MB

  # --- JPA & Datasource ---
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        order_by:
          default_null_ordering: last
        dialect: org.hibernate.dialect.PostgreSQLDialect

  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/core_service}
    username: ${SPRING_DATASOURCE_USERNAME:postgres}
    password: ${SPRING_DATASOURCE_PASSWORD:DnictPro@123}
    driver-class-name: org.postgresql.Driver
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      pool-name: HikariPool-CoreService
      maximum-pool-size: ${HIKARI_MAX_POOL_SIZE:20}
      minimum-idle: ${HIKARI_MIN_IDLE:5}
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      keepalive-time: 30000
      auto-commit: true

  # --- Redis (Lettuce) ---
  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST:localhost}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      password: ${SPRING_DATA_REDIS_PASSWORD:DnictPro@123}
      timeout: 10s
      ssl:
        enabled: ${SPRING_DATA_REDIS_SSL_ENABLED:false}
      lettuce:
        pool:
          max-active: ${REDIS_POOL_MAX_ACTIVE:32}
          max-idle: ${REDIS_POOL_MAX_IDLE:16}
          min-idle: ${REDIS_POOL_MIN_IDLE:4}

  cache:
    type: redis
    redis:
      time-to-live: 3600000
      cache-null-values: true
      enable-statistics: false

  # --- Kafka ---
  kafka:
    bootstrap-servers: ${SPRING_KAFKA_BOOTSTRAP_SERVERS:localhost:29092}
    properties:
      security:
        protocol: ${KAFKA_SECURITY_PROTOCOL:PLAINTEXT}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      retries: 3
      acks: all
    consumer:
      group-id: ${spring.application.name}
      auto-offset-reset: latest
      key-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      properties:
        spring.json.trusted.packages: "*"
        spring.deserializer.key.delegate.class: org.apache.kafka.common.serialization.StringDeserializer
        spring.deserializer.value.delegate.class: org.springframework.kafka.support.serializer.JsonDeserializer
    listener:
      missing-topics-fatal: false
      concurrency: 3

  # --- Boot Admin ---
  boot:
    admin:
      client:
        url: ${SPRING_BOOT_ADMIN_CLIENT_URL:http://localhost:9090}

# -------------------------------------------------------------------
# 3. MANAGEMENT & OBSERVABILITY
# -------------------------------------------------------------------
management:
  endpoints:
    jmx:
      exposure:
        include: "*"
    web:
      exposure:
        include: "*"
      base-path: /actuator
      path-mapping:
        prometheus: metrics/prometheus
  endpoint:
    health:
      show-details: when_authorized
      probes:
        enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
    distribution:
      percentiles-histogram:
        http:
          server:
            requests: true

logging:
  level:
    vn:
      tr: ${LOGGING_LEVEL_VN_TR:INFO}
    org:
      springframework: ${LOGGING_LEVEL_SPRINGFRAMEWORK:WARN}
    com:
      zaxxer:
        hikari: WARN
  config: classpath:logback-spring.xml
  file:
    path: ${LOG_PATH:/opt/logs}

# -------------------------------------------------------------------
# 4. MICROSERVICE INFRASTRUCTURE
# -------------------------------------------------------------------
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://localhost:8061/eureka/}
    registry-fetch-interval-seconds: 10
    disable-delta: true
  instance:
    prefer-ip-address: true
    lease-renewal-interval-in-seconds: 10
    lease-expiration-duration-in-seconds: 30

# -------------------------------------------------------------------
# 5. LIBRARIES & INTEGRATIONS
# -------------------------------------------------------------------
sa-token:
  token-name: X-Token
  timeout: 604800
  active-timeout: 259200
  is-concurrent: true
  is-share: true
  token-style: jwt
  jwt-secret-key: ${JWT_SECRET_KEY:DnictPro@123}
  is-log: false

redisson:
  keyPrefix: ${REDISSON_KEY_PREFIX:${spring.application.name}}
  threads: ${REDISSON_THREADS:4}
  nettyThreads: ${REDISSON_NETTY_THREADS:8}
  singleServerConfig:
    clientName: ${spring.application.name}
    connectionMinimumIdleSize: ${REDISSON_POOL_MIN_IDLE:8}
    connectionPoolSize: ${REDISSON_POOL_MAX_SIZE:32}
    idleConnectionTimeout: ${REDISSON_IDLE_TIMEOUT:10000}
    timeout: ${REDISSON_CMD_TIMEOUT:3000}
    subscriptionConnectionPoolSize: ${REDISSON_SUB_POOL_SIZE:50}

# -------------------------------------------------------------------
# 6. BUSINESS & APP CONFIG
# -------------------------------------------------------------------
vn:
  tr:
    app-code: core

app:
  name: Tr-Pro-App
  version: "@project.version@"
  copyrightYear: 2025

core:
  attachment:
    host:
      download: ${CORE_ATTACHMENT_HOST_DOWNLOAD:https://api.dnict.vn/v2/core}
    path:
      upload: ${CORE_ATTACHMENT_PATH_UPLOAD:/opt/uploads}
      uploadtemp: ${CORE_ATTACHMENT_PATH_UPLOADTEMP:/opt/uploads/temp}

user:
  password:
    maxRetryCount: ${USER_PASSWORD_MAX_RETRY:5}
    lockTime: ${USER_PASSWORD_LOCK_TIME:30}

captcha:
  enable: ${CAPTCHA_ENABLED:true}
  type: CHAR
  category: CIRCLE
  numberLength: 1
  charLength: 4

websocket:
  enabled: ${WEBSOCKET_ENABLED:true}
  path: /resource/websocket
  allowedOrigins: ${WEBSOCKET_ALLOWED_ORIGINS}

security:
  excludes:
    - /css/**
    - /js/**
    - /img/**
    - /assets/**
    - /favicon.ico
    - /error
    - /doc.html
    - /swagger-ui.html
    - /swagger-ui/**
    - /webjars/**
    - /v3/api-docs/**
    - /auth/login
    - /auth/logout
    - /auth/register
    - /auth/captcha/code
    - /mobile/**
    - /attachment/download/**
    - /webhook/**
    - /p/**
    - /eureka/**
    - /actuator/**

api-decrypt:
  enabled: ${API_DECRYPT_ENABLED:false}
  headerFlag: encrypt-key
  publicKey: ${API_DECRYPT_PUBLIC_KEY}
  privateKey: ${API_DECRYPT_PRIVATE_KEY}

client:
  notification-service:
    url: ${CLIENT_NOTIFICATION_SERVICE_URL:http://localhost:8000/v1/notification}

error:
  handling:
    exception-logging: WITH_STACKTRACE
